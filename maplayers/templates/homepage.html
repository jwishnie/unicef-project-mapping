<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<title>
			{{project.name}}
		</title>
		<link rel="stylesheet" type="text/css" href="/static/main.css" />
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js" type="text/javascript"></script>
		<script src="http://www.openlayers.org/api/OpenLayers.js" type="text/javascript"></script>
		<script type="text/javascript">
//<![CDATA[

			$(document).ready(function() {
			    $('li.drawer ul:not(:first)').hide();
			    $('h3.drawer-handle').click(function() {
			        $('li.drawer ul:visible').slideUp().prev().removeClass('open');
			        $(this).addClass('open').next().slideDown();
			    });
			
				$("input[type=checkbox]").each(function()
				{
					this.checked = 'yes';
				});
			
			
				$('.sectorbox').click(mapEvent);
				$('.implementorbox').click(mapEvent);
				
				
				function constructQueryString(selected_filters){
					var qstring = "";
					for(var i=0; i<selected_filters.length; i++){ qstring += "&" + selected_filters[i].name + "=true"}
					return qstring;
				}
				
				function bookmarkUrl(){
					var queryString = "";
					queryString += constructQueryString($(".sectors input[type=checkbox][checked]"));
					queryString += constructQueryString($(".implementors input[type=checkbox][checked]"));
					var boundingBox = map.getExtent();
					var url = document.location.protocol + "//" + document.location.host + 
							  "/?left=" + boundingBox.left + "&bottom=" + 
							  boundingBox.bottom + "&right=" + boundingBox.right + 
							  "&top=" + boundingBox.top;
					url += queryString;
					$('#bookmark').html(url);
				}

			
			
				function mapEvent(event) {
			        var boundingBox = map.getExtent();
					var projects_url = "/projects/bbox/" + boundingBox.left + "/" + 
										boundingBox.bottom + "/" + boundingBox.right + "/" + boundingBox.top + "/";
					var filters = {};
					$(".sectors input[type=checkbox][checked]").each(function(){
						filters[$(this).attr('name')] = true;
					});
					$(".implementors input[type=checkbox][checked]").each(function(){
						filters[$(this).attr('name')] = true;
					});
					
					$.get(projects_url, filters, function(data){
						var projects = eval(data);
						markers.destroy();
						markers = new OpenLayers.Layer.Markers( "Markers" );
						map.addLayer(markers);
						
						var html = "<p>Projects : </p><ol>";
						for(var i=0; i<projects.length; i++){
							html += "<li><div>" + projects[i]['snippet'] + '</div></li>';
							markers.addMarker(new OpenLayers.Marker
											 (new OpenLayers.LonLat(projects[i]['longitude'], 
											      projects[i]['latitude']),icon.clone()));
						}
						html += '</ol>';
						$("#projects").html(html);
					});
					
					bookmarkUrl();
			    }

				var map = new OpenLayers.Map( 'map_canvas' , 
							  {eventListeners: {"moveend": mapEvent}, maxScale : 865124.6923828125, minScale : 110735960.625});
				var layer = new OpenLayers.Layer.WMS( "OpenLayers WMS",
				"http://labs.metacarta.com/wms/vmap0", {layers: 'basic'} );
				map.addLayer(layer);

				var bounds= new OpenLayers.Bounds({{left}}, {{bottom}}, {{right}}, {{top}});
				map.zoomToExtent(bounds);
				map.maxExtent(-180, -90, 180, 90);
				map.minExtent(-10, -10, 10, 10);
				var markers = new OpenLayers.Layer.Markers( "Markers" );
				map.addLayer(markers);
							
				var size = new OpenLayers.Size(10,17);
				var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
				var icon = new OpenLayers.Icon('http://labs.google.com/ridefinder/images/mm_20_blue.png',size,offset);
			
			});

		//]]>
		</script>
	</head>
	<body>
		<div id="wrapper">
			<div id="header">
				<h1>
					Welcome to UNICEF Mapping
				</h1>
			</div>
			<div id="nav"></div>
			<div id="filter_left">
				<ul class="drawers">
				    <li class="drawer">
						<h3 class="drawer-handle open">Sectors</h3>
						<ul class="sectors">
							{% for sector in sectors %}
							<li>
								<input type="checkbox" name="sector_{{sector.id}}" value="{{sector.name}}" class="sectorbox">
								<label>{{sector.name}}</label>
							</li>
							{% endfor %}
						</ul>
					</li>
					
					<li class="drawer">
						<h3 class="drawer-handle">Implementors</h3>
						<ul class="implementors">
							{% for implementor in implementors %}
							<li>
								<input type="checkbox" name="implementor_{{implementor.id}}" value="{{implementor.name}}" class="implementorbox">
								<label>{{implementor.name}}</label> <br/>
							{% endfor %}
							</li>
						</ul>
					</li>
				</ul>
			</div>
			
			
			<div id="main">
				<div id="map_canvas"></div>
				<div id="projects"></div>
				<div id="bookmark"></div>
			</div>
			
			<div id="footer">
				Unicef 2009 : All rights reserved
			</div>
		</div>
	</body>
</html>
